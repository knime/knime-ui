#!/bin/bash
USERNAME='your email' # Your email address here
TOKEN='api token'  # Get one at https://id.atlassian.com/manage/api-tokens

# Read issue ID from branch name, read issue summary from the web,
# and generate a commit message outline.
# This also works with `git commit -m ...`
if [[ -z "$2" || "$2" = "message" ]]; then
  branch=$(git symbolic-ref --short HEAD)
  if [[ $branch =~ ^(.*/)?([A-Z]+-[0-9]+) ]]; then
    issue_id=${BASH_REMATCH[2]}
    cachedir="/tmp/.gitjiratitle"
    cachefile="$cachedir/$issue_id"
    if [[ ! -f "$cachefile" ]]; then
      mkdir -p "$cachedir"
      curl -s -u "$USERNAME":"$TOKEN" https://knime-com.atlassian.net/rest/api/2/issue/"$issue_id"?fields=summary |
        sed -rn 's/.*"summary":"(.*)".*/\1/p' | sed -e 's/\\"/"/g' > "$cachefile"
    fi
    sed -i.bak -e '1s/^\(.*\)$/'"$issue_id":' \1\'$'\n'/ "$1"
    echo "$issue_id ($(<"$cachefile"))" >> "$1"
  fi
fi