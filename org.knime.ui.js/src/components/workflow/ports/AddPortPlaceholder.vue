<script>
import Port from '@/components/common/Port.vue';
import { mapActions, mapMutations, mapState } from 'vuex';

export const addPortPlaceholderPath = (() => {
    let cx = 0;
    let cy = 0;
    const r = 6;

    return `M ${cx} ${cy}
            m -${r}, 0
            a ${r},${r} 0 1,1 ${r * 2},0
            a ${r},${r} 0 1,1 -${r * 2},0`;
})();

export default {
    components: {
        Port
    },
    inject: ['anchorPoint'],
    props: {
        position: {
            type: Array,
            required: true
        },
        side: {
            type: String,
            required: true,
            validator: side => ['input', 'output'].includes(side)
        },
        nodeId: {
            type: String,
            required: true
        },
        portGroups: {
            type: Object,
            default: null
        },
        /** if true, the placeholder will be replaced with a preview of the targetPort */
        targeted: {
            type: Boolean,
            default: false
        },
        /** object that contains information which port to highlight */
        targetPort: {
            type: Object,
            default: null
        }
    },
    data: () => ({
        transitionEnabled: true,
        closeTimeout: null
    }),
    computed: {
        ...mapState('workflow', ['portTypeMenu']),

        addPortPlaceholderPath: () => addPortPlaceholderPath,
        validPortGroups() {
            if (!this.portGroups) {
                return null;
            }

            return Object
                .entries(this.portGroups)
                .filter(([_, group]) => group.canAddInPort || group.canAddOutPort)
                // map back to an object structure after filtering to match the api object shape
                .reduce((acc, [key, value]) => ({ ...acc, [key]: value }), {});
        },
        isMenuOpen() {
            return this.portTypeMenu.isOpen &&
                this.portTypeMenu.nodeId === this.nodeId &&
                this.portTypeMenu.props.side === this.side;
        },
        previewPort() {
            // show either the selected port of the menu or the targeted port for drag & drop to this placeholder
            return this.targeted ? this.targetPort : this.selectedPort;
        },
        selectedPort: {
            // use global store state for preview
            get() {
                return this.portTypeMenu.previewPort;
            },
            set(value) {
                this.setPortTypeMenuPreviewPort(value);
            }
        }
    },
    watch: {
        isMenuOpen(isOpen) {
            // make the + visible when the menu is open and hide it with a timeout of 1sec if it closes
            if (isOpen) {
                this.$el.style.opacity = '1';
                // clear the close-timeout of this button if set
                clearTimeout(this.closeTimeout);
            } else {
                // after closing the menu, keep the add-port button for 1s,
                // then go back to styling by css
                this.closeTimeout = setTimeout(() => {
                    this.$el.style.opacity = null;
                }, 1000);
            }
        }
    },
    methods: {
        ...mapActions('workflow', ['openPortTypeMenu', 'closePortTypeMenu']),
        ...mapMutations('workflow', ['setPortTypeMenuPreviewPort']),
        openMenu() {
            // find the position in coordinates relative to the origin
            let position = {
                x: this.anchorPoint.x + this.position[0],
                y: this.anchorPoint.y + this.position[1]
            };

            this.openPortTypeMenu({
                nodeId: this.nodeId,
                props: {
                    side: this.side,
                    position,
                    portGroups: this.validPortGroups
                },
                events: {
                    'item-active': this.onItemActive,
                    'item-click': this.onItemClick,
                    'menu-close': this.onRequestClose
                }
            });
        },
        closeMenu() {
            this.closePortTypeMenu();
        },
        onClick() {
            if (this.isMenuOpen) {
                this.closeMenu();
                return;
            }

            const portGroups = Object.values(this.validPortGroups || {});

            if (portGroups.length === 1) {
                const { supportedPortTypeIds } = portGroups[0];

                if (supportedPortTypeIds.length === 1) {
                    let [typeId] = supportedPortTypeIds;
                    this.$emit('add-port', { typeId, portGroup: Object.keys(this.validPortGroups)[0] });
                    return;
                }
            }

            this.openMenu();
        },
        onRequestClose(item) {
            if (!item) {
                // If menu closes without selecting an item (eg. when pressing esc), reset preview
                this.selectedPort = null;
            }
            this.closeMenu();
        },

        onItemActive(item) {
            this.selectedPort = item?.port;
        },

        onItemClick({ typeId, portGroup }) {
            // directly switch back to add-port icon
            this.transitionEnabled = false;
            this.selectedPort = null;

            this.$emit('add-port', { typeId, portGroup });

            this.$nextTick(() => {
                this.transitionEnabled = true;
            });
        }
    }
};
</script>

<template>
  <g :transform="`translate(${position})`">
    <transition :name="transitionEnabled ? 'port-fade' : 'none'">
      <Port
        v-if="isMenuOpen && previewPort && previewPort.typeId"
        :key="previewPort.typeId"
        :port="previewPort"
      />
      <!-- placeholder plus icon -->
      <g
        v-else
        :class="['add-port-icon', {
          'active': isMenuOpen
        }]"
        @click="onClick"
      >
        <circle
          r="6.5"
          fill="white"
          stroke="none"
        />
        <path
          :d="addPortPlaceholderPath"
          stroke-width="1"
          stroke="#000"
          fill="none"
          stroke-dasharray="1"
        />
        <line
          y1="0"
          y2="0"
          x1="-3.5"
          x2="3.5"
          stroke="#000"
          stroke-width="1"
        />
        <line
          x1="0"
          x2="0"
          y1="-3.5"
          y2="3.5"
          stroke="#000"
          stroke-width="1"
        />
      </g>
    </transition>
  </g>
</template>

<style lang="postcss" scoped>
.port-fade-enter-active,
.port-fade-leave-active {
  transition: opacity 100ms ease;
}

.port-fade-enter {
  opacity: 0.2;
}

.port-fade-leave-to {
  opacity: 0.2;
}

.add-port-icon {
  cursor: pointer;

  &:hover {
    transition: transform 0.17s cubic-bezier(0.8, 2, 1, 2.5);
    transform: scale(1.15);
  }

  &.active,
  &:active {
    transition: transform 80ms;
    transform: scale(0.8);
  }

  & path,
  & line {
    pointer-events: none;
  }
}

</style>
