<script setup lang="ts">
import { computed, ref, watch } from "vue";
import { useStore } from "vuex";

import Modal from "webapps-common/ui/components/Modal.vue";
import Button from "webapps-common/ui/components/Button.vue";
import InputField from "webapps-common/ui/components/forms/InputField.vue";
import Label from "webapps-common/ui/components/forms/Label.vue";

import { useWorkflowNameValidator } from "@/composables/useWorkflowNameValidator";
import LoadingIcon from "webapps-common/ui/components/LoadingIcon.vue";

const NAME_TEMPLATE = "KNIME_project";

const store = useStore();

const isSubmitted = ref(false);
const inputRef = ref<InstanceType<typeof InputField>>(null);
const workflowName = ref(NAME_TEMPLATE);

const isCreateWorkflowModalOpen = computed(
  () => store.state.spaces.createWorkflowModalConfig.isOpen
);

const activeSpace = computed(() =>
  store.getters["spaces/getWorkflowGroupContent"](
    store.state.spaces.createWorkflowModalConfig.projectId
  )
);
const existingWorkflowNames = computed<Array<string>>(() => {
  const items = activeSpace.value.items ?? [];

  return items.map(({ name }) => name);
});

const { isValid, errorMessage, cleanName } = useWorkflowNameValidator({
  blacklistedNames: existingWorkflowNames,
  name: workflowName,
});

const closeModal = () => {
  store.commit("spaces/setCreateWorkflowModalConfig", {
    isOpen: false,
    projectId: null,
  });
};

const onSubmit = async () => {
  if (isSubmitted.value) {
    return;
  }
  isSubmitted.value = true;
  try {
    const { projectId } = store.state.spaces.createWorkflowModalConfig;
    const workflowItem = await store.dispatch("spaces/createWorkflow", {
      projectId,
      workflowName: cleanName(workflowName.value),
    });

    closeModal();

    await store.dispatch("spaces/openWorkflow", {
      projectId,
      workflowItemId: workflowItem.id,
    });
  } catch (error) {
    consola.log("There was an error creating the workflow", error);
  }
};

const onkeyup = async (keyupEvent: KeyboardEvent) => {
  if (keyupEvent.key === "Enter" && isValid.value) {
    await onSubmit();
  }
};

const setNameSuggestion = () => {
  const isNameInUse = (value: string) =>
    existingWorkflowNames.value.some((name) => name === value);

  if (!isNameInUse(NAME_TEMPLATE)) {
    workflowName.value = NAME_TEMPLATE;
    return;
  }

  let counter = 1;
  while (isNameInUse(`${NAME_TEMPLATE}${counter}`)) {
    counter++;
  }

  workflowName.value = `${NAME_TEMPLATE}${counter}`;
};

watch(
  isCreateWorkflowModalOpen,
  () => {
    if (isCreateWorkflowModalOpen.value) {
      setNameSuggestion();
      setTimeout(() => {
        const inputElement = inputRef.value?.$refs?.input as HTMLInputElement;
        inputElement?.setSelectionRange(0, workflowName.value.length);
        inputElement?.focus();
        // eslint-disable-next-line no-magic-numbers
      }, 200);
    } else {
      // reset on close
      isSubmitted.value = false;
    }
  },
  { immediate: true }
);
</script>

<template>
  <Modal
    v-show="isCreateWorkflowModalOpen"
    ref="modalRef"
    :active="isCreateWorkflowModalOpen"
    title="Create a new workflow"
    style-type="info"
    class="modal"
    @cancel="closeModal"
  >
    <template #confirmation>
      <Label text="Workflow name">
        <div>
          <InputField
            ref="inputRef"
            v-model="workflowName"
            type="text"
            title="Workflow name"
            :disabled="isSubmitted"
            :is-valid="isValid || isSubmitted"
            @keyup="onkeyup"
          />
          <div v-if="!isValid && !isSubmitted" class="item-error">
            <span>{{ errorMessage }}</span>
          </div>
        </div>
      </Label>
    </template>
    <template #controls>
      <Button with-border @click="closeModal">
        <strong>Cancel</strong>
      </Button>
      <Button
        primary
        class="submit-button"
        :disabled="!isValid || isSubmitted"
        @click="onSubmit"
      >
        <LoadingIcon v-if="isSubmitted" />
        <strong>Create</strong>
      </Button>
    </template>
  </Modal>
</template>

<style lang="postcss" scoped>
.modal {
  --modal-width: 400px;
}

.submit-button {
  min-width: 145px;
}

.item-error {
  font-size: 12px;
  font-weight: 400;
  color: var(--theme-color-error);
  margin-top: 7px;
  white-space: normal;
}
</style>
