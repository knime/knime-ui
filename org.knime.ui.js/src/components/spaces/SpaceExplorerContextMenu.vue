<script lang="ts" setup>
import { computed } from "vue";
import type { Dispatch } from "vuex";
import { useStore } from "@/composables/useStore";

import MenuItems, {
  type MenuItem,
} from "webapps-common/ui/components/MenuItems.vue";
import DeleteIcon from "webapps-common/ui/assets/img/icons/trash.svg";
import DuplicateIcon from "webapps-common/ui/assets/img/icons/duplicate.svg";
import RenameIcon from "webapps-common/ui/assets/img/icons/pencil.svg";
import ExportIcon from "webapps-common/ui/assets/img/icons/export.svg";
import type { FileExplorerContextMenu } from "webapps-common/ui/components/FileExplorer/types";

import {
  SpaceItem,
  SpaceProvider as BaseSpaceProvider,
} from "@/api/gateway-api/generated-api";
import {
  buildHubDownloadMenuItem,
  buildMoveInsideHubMenuItem,
  buildHubUploadMenuItems,
  buildOpenInBrowserMenuItem,
  buildOpenAPIDefinitionMenuItem,
  buildOpenPermissionsDialog,
  buildDisplayDeploymentsMenuItem,
  buildExecuteWorkflowMenuItem,
} from "@/components/spaces/remoteMenuItems";

const store = useStore();

const getProviderInfo = computed(() => store.getters["spaces/getProviderInfo"]);

interface Props {
  createRenameOption: FileExplorerContextMenu.CreateDefaultMenuOption;
  createDeleteOption: FileExplorerContextMenu.CreateDefaultMenuOption;
  anchor: FileExplorerContextMenu.Anchor;
  isMultipleSelectionActive: boolean;
  onItemClick: (item: MenuItem) => void;
  closeContextMenu: () => void;
  projectId: string;
  selectedItemIds: Array<string>;
}

const props = defineProps<Props>();

interface Emits {
  (e: "duplicateItems", sourceItems: string[]);
}

const emit = defineEmits<Emits>();

const handleItemClick = (item: MenuItem & { execute?: () => void }) => {
  if (item.execute) {
    item.execute();
    props.closeContextMenu();
    return;
  }
  // use file explorers default impl
  props.onItemClick(item);
};

const valueOrEmpty = <T,>(condition: boolean, value: T) =>
  condition ? [value] : [];

const fileExplorerContextMenuItems = computed(() => {
  const {
    createRenameOption,
    createDeleteOption,
    anchor: { item: anchorItem },
    isMultipleSelectionActive,
  } = props;

  const isLocal = store.getters["spaces/getSpaceInfo"](props.projectId).local;
  const isServer =
    getProviderInfo.value(props.projectId).type ===
    BaseSpaceProvider.TypeEnum.SERVER;

  const selectionContainsFile = store.getters["spaces/selectionContainsFile"](
    props.projectId,
    props.selectedItemIds,
  );

  const selectionContainsWorkflow = store.getters[
    "spaces/selectionContainsWorkflow"
  ](props.projectId, props.selectedItemIds);

  const downloadToLocalSpace = buildHubDownloadMenuItem(
    store.dispatch,
    props.projectId,
    props.selectedItemIds,
  );

  const moveInsideHub = buildMoveInsideHubMenuItem(
    store.dispatch,
    props.projectId,
    props.selectedItemIds,
  );

  const openInBrowser = buildOpenInBrowserMenuItem(
    store.dispatch,
    props.projectId,
    props.selectedItemIds,
    getProviderInfo.value(props.projectId),
  );

  const openAPIDefinition = buildOpenAPIDefinitionMenuItem(
    store.dispatch,
    props.projectId,
    props.selectedItemIds,
  );

  const uploadAndConnectToHub = buildHubUploadMenuItems(
    store.dispatch,
    store.getters["spaces/hasActiveHubSession"],
    props.projectId,
    props.selectedItemIds,
    store.state.spaces.spaceProviders,
  );

  const getHubActions = () => {
    if (isLocal) {
      return uploadAndConnectToHub;
    }

    if (isServer) {
      return [];
    }

    if (selectionContainsFile) {
      return [downloadToLocalSpace, moveInsideHub];
    }

    return [downloadToLocalSpace, moveInsideHub, openInBrowser];
  };

  const displayDeployments = buildDisplayDeploymentsMenuItem(
    store.dispatch,
    props.projectId,
    props.selectedItemIds,
    anchorItem.name,
  );

  const openPermissionsDialog = buildOpenPermissionsDialog(
    store.dispatch,
    props.projectId,
    props.selectedItemIds,
  );

  const executeWorkflow = buildExecuteWorkflowMenuItem(
    store.dispatch,
    props.projectId,
    props.selectedItemIds,
  );

  const getServerActions = () => {
    if (!isServer) {
      return [];
    }

    if (!selectionContainsWorkflow) {
      return [openInBrowser, openPermissionsDialog];
    }

    return [
      downloadToLocalSpace,
      executeWorkflow,
      displayDeployments,
      openInBrowser,
      openAPIDefinition,
      openPermissionsDialog,
    ];
  };

  const createExportItemOption = (
    dispatch: Dispatch,
    projectId: string,
    selectedItems: Array<string>,
  ) => {
    const isSelectionMultiple = selectedItems.length > 1;
    return {
      id: "export",
      text: "Export",
      icon: ExportIcon,
      disabled: selectionContainsFile || isSelectionMultiple,
      execute: () => {
        dispatch("spaces/exportSpaceItem", {
          projectId,
          itemId: selectedItems[0],
        });
      },
    };
  };

  const openFileType =
    anchorItem.meta.type === SpaceItem.TypeEnum.Workflow
      ? "workflows"
      : "folders";

  const createDuplicateItemOption = () => {
    return {
      id: "duplicate",
      text: "Duplicate",
      icon: DuplicateIcon,
      title: anchorItem.isOpen
        ? `Open ${openFileType} cannot be duplicated.`
        : null,
      disabled: anchorItem.isOpen,
      execute: () => emit("duplicateItems", props.selectedItemIds),
    };
  };

  const renameOptionTitle = anchorItem.isOpen
    ? `Open ${openFileType} cannot be renamed`
    : "";

  const contextMenuItems = [
    // hide rename for multiple selected items
    ...valueOrEmpty(
      !isMultipleSelectionActive,
      createRenameOption(anchorItem, {
        title: renameOptionTitle,
        icon: RenameIcon,
      }),
    ),

    createDeleteOption(anchorItem, {
      title: anchorItem.canBeDeleted ? "" : "Open folders cannot be deleted",
      icon: DeleteIcon,
    }),

    createDuplicateItemOption(),

    ...valueOrEmpty(
      isLocal,
      createExportItemOption(
        store.dispatch,
        props.projectId,
        props.selectedItemIds,
      ),
    ),

    ...getHubActions(),
    ...getServerActions(),
  ];

  return contextMenuItems;
});
</script>

<template>
  <MenuItems
    id="space-explorer-context-menu"
    menu-aria-label="Space explorer context menu"
    class="menu-items"
    :items="fileExplorerContextMenuItems"
    @item-click="(_, item) => handleItemClick(item)"
  />
</template>
